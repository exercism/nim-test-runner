name: CI
on: [push, pull_request]

jobs:
  job1:
    name: trunner.nim
    runs-on: ubuntu-latest
    container: nimlang/nim:latest

    steps:
    - uses: actions/checkout@v2

    - name: Compile and run `tests/trunner.nim`
      run: nim c -r --styleCheck:error '--hint[Processing]:off' tests/trunner.nim

  job2:
    name: Docker - build image and run
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Download all nim exercises
      run: git clone --depth 1 https://github.com/exercism/nim.git

    - name: Build image
      run: docker build -t exercism/nim-test-runner .

    - name: Test bin/run.sh and bin/runner
      run: |
        docker create --name ntr --entrypoint 'bin/run.sh' \
          exercism/nim-test-runner hello-world /tmp/ /tmp/out/
        docker cp nim/exercises/hello-world/hello_world_test.nim ntr:/tmp/
        docker cp nim/exercises/hello-world/example.nim ntr:/tmp/hello_world.nim
        docker start -a ntr
        docker cp ntr:/tmp/out/results.json results.json
        docker rm ntr
        printf '{"status":"pass","tests":[{"name":"say hi","status":"pass","output":""}]}' \
          > expected_results.json
        diff results.json expected_results.json

    - name: Run image to test all exercises mounted from github repo
      run: docker run -v ${PWD}/nim/:/mnt/nim exercism/nim-test-runner
